%===============================================================================
% biblatex_science_mods.sty
%
% DESCRIPTION:
%   Modifications and customizations to the biblatex-science style for use in
%   an academic CV. This package handles entry type customizations (article,
%   patent, incollection, inproceedings, misc, online), implements reverse-order
%   numbering for publications, adds icon links to DOI/URL/PMCID/cover images,
%   and highlights selected authors.
%
% AUTHOR:
%   Matthew Lew
%
% VERSION & DATE:
%   v1.0 – 2025/11/04 (Initial release)
%
% LICENSE:
%   (Specify your license here, e.g., MIT, CC BY 4.0, etc.)
%
%===============================================================================
% DEPENDENCIES:
%
%   REQUIRED:
%     • biblatex (core functionality)
%     • etoolbox (for \AtDataInput, \csnumgdef, etc.)
%     • hyperref (for \href)
%
%   RECOMMENDED:
%     • fontawesome7 (for \faArrowUpRightFromSquare, \faFileLines, \faImage, \faStar)
%       Note: fontawesome5 is also compatible but deprecated. Use fontawesome7 for consistency with cvstyle.sty.
%     • cvstyle.sty (defines primary \iconlink macro with layout tweaks)
%
%   LOAD ORDER:
%     This package must be loaded AFTER biblatex but ideally BEFORE cvstyle.sty
%     if you want the enhanced \iconlink from cvstyle to override the fallback
%     defined herein. See the \iconlink note below.
%
%===============================================================================
% TABLE OF CONTENTS:
%
%   1. Auxiliary Macros & Setup
%   2. Entry Count & Reverse Numbering System
%   3. Author Highlighting
%   4. Generic Field Formats (article, patent)
%   5. Icons & Links in Bibliography Entries
%   6. Entry Type Drivers: @article (patent) – Title included
%   7. Entry Type Drivers: @incollection – Chapter title before booktitle
%   8. Entry Type Drivers: @inproceedings – Custom field formats & driver
%   9. Entry Type Drivers: @misc – For talks/presentations
%  10. Entry Type Drivers: @online – Org in italics, no URL display
%
%===============================================================================

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{biblatex_science_mods}[2025/11/04 v1.0 Modifications to biblatex-science for CV]

% Require minimum package versions for stability
% etoolbox 2.5 (2011) provides \csnumgdef and \AtDataInput
\RequirePackage{etoolbox}[2011/01/03]

%===============================================================================
% 1. AUXILIARY MACROS & SETUP
%===============================================================================

% MACRO: \iconlink{<icon>}{<url>}{<text>}
%   Helper macro for printing icons with hyperlinks in bibliography entries.
%
%   CANONICAL DEFINITION:
%     The primary definition (with layout/spacing tweaks) lives in cvstyle.sty.
%     To use the enhanced version, ensure cvstyle.sty loads this package
%     (place \RequirePackage{biblatex_science_mods} after \iconlink is defined).
%
%   FALLBACK:
%     If \iconlink is not yet defined at load time, we define a minimal version
%     here using \href so icons render immediately. This fallback:
%       • Raises the icon by –0.05×height to vertically align with text
%       • Adds a small space between icon and text
%       • Uses \href{#2} to make the link active
%     Using \providecommand ensures no conflict if cvstyle.sty loads first.
%
%   PARAMETERS:
%     #1  Icon command (e.g., \faArrowUpRightFromSquare from fontawesome7)
%     #2  URL to link to (e.g., https://doi.org/10.1234/...)
%     #3  Display text after icon (optional; often empty for icon-only links)
%
%   ROBUSTNESS:
%     - \providecommand only defines if not already defined (prevents conflicts)
%     - Compatible with both 3-argument (here) and 4-argument (cvstyle) versions
%
\providecommand{\iconlink}[3]{\href{#2}{\raisebox{-0.05\height}{#1}\ #3}}


%===============================================================================
% 2. ENTRY COUNT & REVERSE NUMBERING SYSTEM
%===============================================================================
% This system implements reverse numbering for publications (most recent first).
% E.g., if there are 5 entries, the 1st is labeled [5], 2nd is [4], ..., 5th is [1].
%
% MECHANISM:
%   • \AtDataInput: Increments counter for current refsection as data is read
%   • \mkbibdesc: Computes label as (total entries) + 1 − (actual label)
%   This requires entries to be processed in forward order; sorting must happen
%   in the .bib file or via biblatex sorting options.

% Count total number of entries in each refsection
\AtDataInput{%
  \csnumgdef{entrycount:\therefsection}{%
    \csuse{entrycount:\therefsection}+1}}

% Print the label number as (total in this refsection) - (actual label) + 1
\DeclareFieldFormat{labelnumber}{\mkbibdesc{#1}}
\newrobustcmd*{\mkbibdesc}[1]{%
  \number\numexpr\csuse{entrycount:\therefsection}+1-#1\relax}

%===============================================================================
% 3. AUTHOR HIGHLIGHTING
%===============================================================================
% Allows selective highlighting of authors (e.g., to highlight yourself in
% publication lists). To enable, add annotation=highlight to the author entry
% in your .bib file, e.g.:
%   author = {Smith, John and \textbf{Lew, Matthew} and Brown, Jane}
%
% Or use biblatex's annotation key if your .bib parser supports it.

\renewcommand*{\mkbibnamegiven}[1]{%
  \ifitemannotation{highlight}
    {\textbf{#1}}
    {#1}}
\renewcommand*{\mkbibnamefamily}[1]{%
  \ifitemannotation{highlight}
    {\textbf{#1}}
    {#1}}

%===============================================================================
% 4. GENERIC FIELD FORMATS (Used by multiple entry types)
%===============================================================================

% Article: support for PMCID field (NIH PubMed Central ID)
% Format: store the raw PMCID value for later use in entry drivers
\DeclareFieldFormat[article]{pmcid}{#1}

%===============================================================================
% 5. ICONS & LINKS IN BIBLIOGRAPHY ENTRIES
%===============================================================================
% This section customizes the final entry output to include icon links for:
%   • DOI (preferred) or URL (fallback)
%   • PMCID (NIH PubMed Central ID)
%   • Cover image (stored in usera field)
%   • Editor's pick badge (stored in userb field)
%   • Correction note (stored in userc field)
%
% All icons use the \iconlink macro and are separated by \hspace{2mm} (2 millimeters)
% for readability.
%
% SPACING RATIONALE:
%   2mm spacing (≈ 0.08 inches) balances visual separation without excessive gaps
%   and aligns well with typical font sizes (10–12pt for CV).
%
% FIELD MAPPING:
%   usera  → URL for cover image link (displayed as "Cover" icon link)
%   userb  → URL for editor's pick link (displayed as ★ star icon)
%   userc  → URL for correction note (displayed as link text "Correction")

%---- Helper macro for conditional icon insertion ----
% Usage: \addicon{<icon>}{<url>}{<text>}
%   Adds a left-aligned icon link with \hspace{2mm} separator
\newcommand*{\addicon}[3]{\hspace{2mm}\iconlink[url]{#1}{#2}{#3}}

% Modified \finentry: add icons after the standard entry closes
\renewbibmacro*{finentry}{%
  % Close the entry first
  \finentry%
  %
  % —— DOI or URL (DOI preferred) ——
  \iffieldundef{doi}{%
    % No DOI: check for URL
    \iffieldundef{url}{%
      % No DOI and no URL: nothing to link
    }{%
      % URL present but no DOI
      \addicon{\small\faArrowUpRightFromSquare}{\thefield{url}}{}%
    }%
  }{%
    % DOI is present: create DOI link
    \addicon{\small\faFileLines}{https://doi.org/\thefield{doi}}{\thefield{doi}}%
  }%
  %
  % —— PMCID (if present) ——
  \iffieldundef{pmcid}{}{%
    \addicon{\small\faFileLines}{https://pmc.ncbi.nlm.nih.gov/articles/\thefield{pmcid}/}{\thefield{pmcid}}%
  }%
  %
  % —— Cover image (if present, stored in usera) ——
  \iffieldundef{usera}{}{%
    \addicon{\small\faImage}{\thefield{usera}}{Cover}%
  }%
  %
  % —— Editor's pick (if present, stored in userb) ——
  \iffieldundef{userb}{}{%
    \addicon{\small\faStar}{\thefield{userb}}{}%
  }%
  %
  % —— Correction note (if present, stored in userc) ——
  \iffieldundef{userc}{}{%
    \addicon{\small\faArrowUpRightFromSquare}{\thefield{userc}}{Correction}%
  }%
}

%===============================================================================
% 6. ENTRY TYPE DRIVERS: @article (via @patent in this file)
%===============================================================================
% DESCRIPTION:
%   Customized @patent entry type driver to handle patent bibliographies.
%   Modified from Science default to include the patent title.
%
% FIELD FORMATS & OUTPUT ORDER:
%   author, type, number, title, DOI/URL, year, addendum/pubstate
%
% RATIONALE:
%   Patents are legally identified by (author, number, year), so we preserve
%   this while adding the descriptive title for readability in CVs.

% Patent title field format (plain, no quotes)
\DeclareFieldFormat[patent]{title}{#1}

\DeclareBibliographyDriver{patent}{%
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  \usebibmacro{author}%
  \setunit{\labelnamepunct}\newblock
  \printlist{language}%
  \newunit\newblock
  \usebibmacro{byauthor}%
  \newunit\newblock
  % Title (uses field format defined above)
  \usebibmacro{title}%
  \newunit\newblock
  \printfield{type}%
  \newunit
  \printfield{number}%
  % Commented out: location field (uncomment if needed for specific use cases)
  %\iflistundef{location}{}{%
  %  \setunit*{\addspace}%
  %  \printtext[parens]{%
  %    \printlist[][-\value{listtotal}]{location}}}%
  %\newunit\newblock
  %\printfield{note}%
  \newunit\newblock
  \usebibmacro{doi+eprint+url}%
  \newunit
  \nopunct
  \printfield[parens]{year}%
  \newunit\newblock
  \usebibmacro{addendum+pubstate}%
  \setunit{\bibpagerefpunct}\newblock
  \usebibmacro{pageref}%
  \newunit\newblock
  \iftoggle{bbx:related}{\usebibmacro{related:init}\usebibmacro{related}}{}%
  \usebibmacro{finentry}%
}

%===============================================================================
% 7. ENTRY TYPE DRIVERS: @incollection
%===============================================================================
% DESCRIPTION:
%   Customized @incollection driver (book chapter) that includes the chapter
%   title before the "In:" booktitle section.
%
% MODIFICATION FROM Science DEFAULT:
%   • Adds chapter title immediately after author list (before "In:")
%   • Improves readability for CV entries where chapter title is descriptive
%
% OUTPUT STRUCTURE:
%   Author, Chapter Title, In: Book Title (Editor), Publisher, Year

\DeclareBibliographyDriver{incollection}{%
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  \usebibmacro{author/translator+others}%
  \setunit{\labelnamepunct}\newblock
  \printlist{language}%
  \newunit\newblock
  \usebibmacro{byauthor}%
  \newunit\newblock
  % CUSTOM: Print chapter title before the "In:" block
  \printtext{\printfield[titlecase]{title}}%
  \newunit\newblock
  % Proceed with standard incollection fields
  \usebibmacro{in:}%
  \usebibmacro{maintitle+booktitle}%
  \newunit\newblock
  \usebibmacro{byeditor+others}%
  \newunit\newblock
  \printfield{volumes}%
  \newunit\newblock
  \printfield{note}%
  \newunit\newblock
  \usebibmacro{publisher+location+date}%
  \newunit\newblock
  \printfield{volume}%
  \newunit
  \usebibmacro{chapter+pages}%
  \newunit\newblock
  \iftoggle{bbx:isbn}{\printfield{isbn}}{}%
  \newunit\newblock
  \usebibmacro{doi+eprint+url}%
  \newunit\newblock
  \usebibmacro{addendum+pubstate}%
  \setunit{\bibpagerefpunct}\newblock
  \usebibmacro{pageref}%
  \newunit\newblock
  \iftoggle{bbx:related}{\usebibmacro{related:init}\usebibmacro{related}}{}%
  \usebibmacro{finentry}%
}

% --- Field formats (inproceedings only) ---
\DeclareFieldFormat[inproceedings]{title}{#1}     % plain, no quotes
\DeclareFieldFormat[inproceedings]{booktitle}{\mkbibemph{#1}}   % italic
\DeclareFieldFormat[inproceedings]{pages}{#1}                  % no "p." / "pp."
\DeclareFieldFormat[inproceedings]{volume}{\mkbibbold{#1}}     % bold, no "vol."
\DeclareFieldFormat[inproceedings]{volumes}{\mkbibbold{#1}}    % bold, no "vols."

%===============================================================================
% 8. ENTRY TYPE DRIVERS: @inproceedings
%===============================================================================
% DESCRIPTION:
%   Customized @inproceedings driver for conference proceedings (e.g., SPIE).
%   Heavily modified from Science default to improve CV readability.
%
% MODIFICATIONS FROM Science DEFAULT:
%   1. Title inserted immediately after author list (not buried later)
%   2. No "presented at the" prefix before booktitle
%   3. Volume placed directly after booktitle with no comma between them
%      → Result: "Proc. SPIE 12853" not "Proc. SPIE, 12853"
%   4. Year in parentheses at the very end
%
% OUTPUT STRUCTURE:
%   Author, Title, Booktitle Volume (Conference, Venue, Date), Pages (Year)

% Driver for @inproceedings
\DeclareBibliographyDriver{inproceedings}{%
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  \usebibmacro{author/translator+others}%
  \setunit{\labelnamepunct}\newblock
  \printlist{language}%
  \newunit\newblock
  \usebibmacro{byauthor}%
  \newunit\newblock
  % CUSTOM: Title immediately after author list
  \usebibmacro{title}%
  \newunit\newblock
  % CUSTOM: No "presented at the" prefix; go straight to booktitle
  %         Locally suppress Science comma between units to avoid "Proc. SPIE, 12853"
  \begingroup
    \renewcommand*{\newunitpunct}{\addspace}%
    \usebibmacro{maintitle+booktitle}%
    \setunit*{\addspace}%
    \printfield{volume}%
    \printfield{part}%
  \endgroup
  \newunit\newblock
  \printfield{volumes}%
  \newunit\newblock
  \printfield{note}%
  \newunit\newblock
  \usebibmacro{event+venue+date}%
  \newunit\newblock
  % Pages without "p." or "pp." prefix
  \usebibmacro{chapter+pages}%
  \newunit\newblock
  \iftoggle{bbx:isbn}{\printfield{isbn}}{}%
  \newunit\newblock
  \usebibmacro{doi+eprint+url}%
  \newunit\newblock
  \usebibmacro{addendum+pubstate}%
  \setunit{\bibpagerefpunct}\newblock
  \usebibmacro{pageref}%
  \newunit\newblock
  % CUSTOM: Year at the end, in parentheses
  \nopunct
  \printtext[parens]{\usebibmacro{date}}%
  \newunit\newblock
  \iftoggle{bbx:related}{\usebibmacro{related:init}\usebibmacro{related}}{}%
  \usebibmacro{finentry}%
}

%===============================================================================
% 9. ENTRY TYPE DRIVERS: @misc
%===============================================================================
% DESCRIPTION:
%   Customized @misc driver for talks and presentations. This driver formats
%   entries to display as: Title, Venue (italics), Location, (Date).
%
% FIELD MAPPING:
%   title        → Name of the talk or presentation
%   howpublished → Venue/conference/event (printed in italics)
%   location     → City/institution where presented
%   month, year  → Date of presentation
%
% NOTES:
%   • Inline formatting prevents spurious line breaks
%   • Date is always in parentheses at the end
%   • All fields are optional; missing fields are skipped transparently

% Field formats for @misc
\DeclareFieldFormat[misc]{title}{#1}
\DeclareFieldFormat[misc]{howpublished}{\mkbibemph{#1}}

% Month+Year helper macro (combines month and year, or just year if month absent)
\newbibmacro*{month+year}{%
  \iffieldundef{year}{}{%
    \iffieldundef{month}{\printfield{year}}{\printfield{month}\space\printfield{year}}}}

% Driver for @misc
\DeclareBibliographyDriver{misc}{%
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  % Title with comma after
  \printfield{title}\addcomma\space
  % howpublished (italic) with comma after
  \printfield[howpublished]{howpublished}\addcomma\space
  % If location exists, add comma+space before it; otherwise only space
  \iffieldundef{location}
    {\setunit{\addspace}}
    {\setunit{\addcomma\space}}%
  \printlist{location}%
  % Before the date, force only a space (never a comma)
  \setunit{\addspace}%
  \iffieldundef{year}{}{%
    \printtext[parens]{\usebibmacro{month+year}}}%
  \newunit\newblock
  \usebibmacro{doi+eprint+url}%
  \usebibmacro{finentry}%
}

%===============================================================================
% 10. ENTRY TYPE DRIVERS: @online
%===============================================================================
% DESCRIPTION:
%   Customized @online driver for web resources. Formats entries as:
%   Author, Title, Organization (Year).
%
% FIELD MAPPING:
%   author/editor → Who created/maintains the resource
%   title        → Name of the resource (plain text, not linked)
%   organization → Organization hosting the resource (italic)
%   year         → Publication/access year
%
% MODIFICATIONS FROM Science DEFAULT:
%   • Title is upright (normal font), not italic
%   • Organization is italic (emphasizes the provider)
%   • URL is NOT displayed (kept in data but not shown)
%   • DOI/eprint are NOT displayed
%   • Uses inline punctuation; no spurious line breaks
%
% RATIONALE:
%   CVs typically don't need full URLs for web resources, focusing instead on
%   the organization and resource name. This keeps entries concise while remaining
%   informative. The URL is available in the .bib file if needed.

% Field formats for @online
\DeclareFieldFormat[online]{title}{\normalfont#1}  % upright, not italic

% Organization formatting: italic (both as \printlist and as \printfield)
\DeclareListFormat[online]{organization}{\mkbibemph{#1}}
\DeclareFieldFormat[online]{organization}{\mkbibemph{#1}}

% Suppress URL/eprint/DOI for @online entries (keep data intact, just don't display)
\AtEveryBibitem{%
  \ifentrytype{online}{%
    \renewbibmacro*{url+urldate}{}%
    \renewbibmacro*{doi+eprint+url}{}%
  }{}%
}

% Driver for @online
\DeclareBibliographyDriver{online}{%
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  % Locally neutralize Science’s block separator to avoid line breaks
  \begingroup
    \renewcommand*{\newblock}{\addcomma\space}%
    \renewcommand*{\newunitpunct}{\addcomma\space}%
    % Author/editor
    \usebibmacro{author/translator+others}%
    \setunit{\addcomma\space}%
    % Title (upright via field format)
    \usebibmacro{title}%
    % Organization (italic via field format)
    \setunit{\addcomma\space}%
    \printlist{organization}%
    % Year at the end (assumed date=year option in biblatex)
    \setunit{\addspace}%
    \nopunct
    \printtext[parens]{\usebibmacro{date}}%
  \endgroup
  \usebibmacro{finentry}%
}

%===============================================================================
% VERSION HISTORY
%===============================================================================
% v1.0 (2025/11/04) - Initial release
%   * Reverse numbering system for publications (most recent first)
%   * Author highlighting support (via annotation=highlight)
%   * Icon links for DOI, PMCID, cover images, editor's picks, corrections
%   * Custom drivers for: @patent, @incollection, @inproceedings, @misc, @online
%   * Improved field formatting for conference proceedings (no spurious commas)
%   * Helper macro \addicon for consistent icon spacing
%   * Comprehensive documentation and section organization

%===============================================================================
% TROUBLESHOOTING & KNOWN ISSUES
%===============================================================================
%
% ICONS NOT DISPLAYING IN BIBLIOGRAPHY:
%   • Ensure fontawesome7 (or fontawesome5) is installed: tlmgr install fontawesome7
%   • Check that icon commands exist: \faFileLines, \faArrowUpRightFromSquare, etc.
%   • Verify cvstyle.sty or this package loads before \begin{document}
%
% REVERSE NUMBERING INCORRECT:
%   • Counter increments via \AtDataInput on each bibliography entry
%   • If entries appear out of order, check .bib file sorting or biblatex sorting options
%   • Run: biber --validate-datamodel cv.bcf to check for data errors
%
% LOAD ORDER CONFLICTS:
%   • This package must load AFTER biblatex but BEFORE \begin{document}
%   • If cvstyle.sty also loads biblatex, ensure consistent options
%   • \iconlink conflicts: this uses 3-arg version, cvstyle uses 4-arg version
%     Both use \providecommand to coexist; last loaded wins
%
% CUSTOM FIELDS NOT WORKING (usera, userb, userc):
%   • These fields store URLs for cover/editor's pick/correction links
%   • Ensure fields are defined in your .bib entries, e.g.: usera = {https://...}
%   • If icons still don't appear, verify field names match exactly (case-sensitive)
%
% AUTHOR HIGHLIGHTING NOT WORKING:
%   • Add annotation=highlight to target author in .bib file
%   • Example: author = {Smith, J. and {Lew, Matthew and[annotation=highlight]} and Doe, J.}
%   • Or use biblatex's built-in annotation mechanism if supported by your .bib editor
%
% COMPATIBILITY WITH OLDER BIBLATEX VERSIONS:
%   • Requires biblatex 3.16+ (2020) for stable \IfEntryType and \iffieldundef
%   • If using older versions, some conditionals may fail silently
%   • Update your TeX distribution: tlmgr update --self --all
