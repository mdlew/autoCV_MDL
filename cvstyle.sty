%% cvstyle.sty -- shared preamble, macros, and layout for cv.tex
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cvstyle}[2026/01/28 v1.2 MDL CV style]

% -------------------------
% Packages (grouped & ordered)
% -------------------------
% Basic helpers: URL handling, paragraph spacing
\RequirePackage{url}
\RequirePackage{parskip}

% Graphics & color (use xcolor; do not load `color` separately)
\RequirePackage{graphicx}
\RequirePackage[usenames,dvipsnames]{xcolor}
\RequirePackage[letterpaper,scale=0.9]{geometry}

% Page numbering / header & footer
\RequirePackage{lastpage}
\RequirePackage{fancyhdr}

% -------------------------
% Header/footer behavior
% -------------------------
% Mark section titles for footer
\makeatletter
\renewcommand{\sectionmark}[1]{\markright{#1}}
\renewcommand{\subsectionmark}[1]{\markright{#1}}
\makeatother

\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\fancyhf{}
\fancyfoot[L]{\footnotesize MDL CV -- \nouppercase{\rightmark}}
\fancyfoot[R]{\footnotesize \thepage\ of \pageref{LastPage}}
\fancypagestyle{plain}{%
  \renewcommand{\headrulewidth}{0pt}%
  \fancyhf{}%
  \fancyfoot[L]{\footnotesize MDL CV -- \nouppercase{\rightmark}}%
  \fancyfoot[R]{\footnotesize \thepage\ of \pageref{LastPage}}%
}
\AtBeginDocument{\thispagestyle{empty}}

% -------------------------
% Layout helpers
% -------------------------
% \RequirePackage{tabularx}
\RequirePackage{array}
\RequirePackage{ltablex}
\keepXColumns % preserves X column behavior across pages
\newcommand{\tablerowskip}{3.75pt}
% width holder for the right column in \cvperson
\setlength{\LTpre}{0pt}
\setlength{\LTpost}{\tablerowskip}

% Lists, enumerations, and reverse enumerations
\RequirePackage{etaremune}
\RequirePackage{enumitem} % make sure enumitem understands etaremune lists

% Small length used in a few places
\newlength{\cvpersonRightWidth} % renamed: no @ needed
\newlength{\fullcollw}
\setlength{\fullcollw}{0.47\textwidth}

% Section formatting and multi-column layout
\RequirePackage{titlesec}
\RequirePackage{multicol}
\RequirePackage{needspace} % to make sure some headings stay with the following text
\RequirePackage{ragged2e}   % for \RaggedRight (better than \raggedright)

\titleformat{\section}{\Large\scshape\raggedright}{}{0em}{}[\titlerule]
\titlespacing{\section}{0pt}{10pt}{10pt}
\titleformat{\subsection}{\bfseries\raggedright}{}{0em}{}
\titlespacing{\subsection}{0pt}{10pt}{\tablerowskip}

% Icon + link helper
% \iconlink[<anything>]{<icon>}{<target URL>}{<label>}
% If [] is present, label is typeset with \nolinkurl; else plain.
% \nolinkurl allows hyperref to break visible text like a url
\newcommand{\iconlink}[4][]{%
  % #1 = optional flag (when present, #4 is typeset with \nolinkurl)
  % #2 = icon or small graphic (e.g., \small\faGoogleScholar)
  % #3 = URL
  % #4 = visible text (may be empty)
  \if\relax\detokenize{#1}\relax
    % Optional flag NOT provided
    \href{#3}{\raisebox{-0.05\height}{#2}~#4}%
  \else
    % Optional flag provided
    \href{#3}{\raisebox{-0.05\height}{#2}~\nolinkurl{#4}}%
  \fi
}
% Optional to keep the font consistent:
\urlstyle{same}

% -------------------------
% Bibliography
% -------------------------
% Keep the 'science' style and local modifications package
\RequirePackage[style=science, datamodel=article-pmcid, maxnames=99, articletitle=true, date=year, isbn=false, eprint=false, url=false]{biblatex}
\RequirePackage{biblatex_science_mods}

% -------------------------
% Icons, PDF/A and hyperlinks
% -------------------------
\RequirePackage{fontawesome7}
\RequirePackage[a-2b]{pdfx}  % loads hyperref
\RequirePackage[open]{bookmark}
\definecolor{linkcolour}{rgb}{0,0.2,0.6}
\hypersetup{
  draft=false,
  colorlinks,
  breaklinks,
  urlcolor=linkcolour,
  linkcolor=linkcolour
}

\setlength\bibitemsep{\tablerowskip}

% -------------------------
% Small utility macros
% -------------------------

% for custom macros
\RequirePackage{xparse}

% If-non-empty helper specifically for optional URL arguments
\newcommand{\IfNonEmptyURL}[2]{%
  \if\relax\detokenize{#1}\relax
  \else
    #2%
  \fi
}

% activity listing environment
\newenvironment{activityshort}[2]
{
    \begin{tabularx}{\linewidth}{@{}l X r@{}}
    \textit{#1} & \hfill & #2
    \end{tabularx} \par%
}
{
}

\newcommand{\activitynone}[2][]{%
    \begin{tabularx}{\linewidth}{@{}l X r@{}}
    \textit{#1} & \hfill & #2
    \end{tabularx} \par%
}

% list activity as row in table instead
\newcommand{\activityrow}[4][]{%
  % #1 = optional URL (may be empty)
  % #2 = title
  % #3 = organization (may be empty)
  % #4 = year(s)
  % Title with optional link:
  \if\relax\detokenize{#1}\relax
    % No URL provided
    #2%
  \else
    % URL provided
    \href{#1}{#2}%
  \fi
  % Optional org (adds comma only if non-empty):
  \if\relax\detokenize{#3}\relax
    % Org empty: print nothing
  \else
    , \textit{#3}%
  \fi
  \space & #4 \\[\tablerowskip]%
}

% set spacing for all lists
\setlist{itemsep=\tablerowskip, topsep=0pt, parsep=0pt}
% typography tweaks for itemize
\renewcommand{\labelitemi}{}
\setlist[itemize,1]{leftmargin=0pt}

% teaching, service column types
\newcolumntype{Y}{>{\raggedright\arraybackslash}p{0.53\textwidth}}
\newcolumntype{Z}{>{\raggedleft\arraybackslash}X}

\newcommand{\teachinstitution}[1]{%
  \multicolumn{2}{l}{\textbf{#1}}\\[\tablerowskip]%
}

\newcommand{\teachentry}[4]{%
  \emph{#1} & #3 \\%
  #2 &%
  \if\relax\detokenize{#4}\relax\else#4\fi%
  \\[\tablerowskip]%
}

% -------------------------
% New, compact macros (public API)
% -------------------------

% \cvcontact{<Name>}{<address/contact line>}{<links line>}
%   #1: full name (printed large)
%   #2: address/contact (single line)
%   #3: extra links (ORCID, website, scholar, etc.)
\newcommand{\cvcontact}[3]{%
  \noindent
  \begin{minipage}{\linewidth}
    {\Huge #1\par\vspace{\tablerowskip}}%
    \RaggedRight #2\par
    \RaggedRight #3\par
  \end{minipage}%
}

% \cvjob{<title>}{<dates>}[<optional content>]
%   #1: job title / appointment text
%   #2: dates (string)
%   [#3]: optional content token (often an itemize or description block)
\NewDocumentCommand{\cvjob}{ m m o }{%
  \begin{tabularx}{\linewidth}{@{}l X r@{}}%
    \textbf{#1} & \hfill & #2%
  \end{tabularx}%
  % --- Remove extra blank line between Row 1 and Row 2 ---
  \IfValueT{#3}{%
    \vspace{-\parskip}%
    \noindent\begin{minipage}[t]{\linewidth}%
      #3%
    \end{minipage}%
  }%
  \par\vspace{\tablerowskip}%
}

\NewDocumentCommand{\cvperson}{ o m m o o o }{%
  % #1 (opt) Google Scholar URL (adds icon after name)
  % #2 Name + affiliation (left)
  % #3 Year/status (right)
  % #4 (opt) Secondary line (e.g., thesis/dissertation title)
  % #5 (opt) Link for #4 (adds icon)
  % #6 (opt) Tertiary line (e.g., current position)
  \begingroup
    \setlength{\tabcolsep}{0pt}%
    \renewcommand{\arraystretch}{1}%

    % Measure the natural width of the right cell (#3)
    \settowidth{\cvpersonRightWidth}{\strut #3}%
    % Clamp to avoid negative p{...} when #3 is too wide
    \ifdim\cvpersonRightWidth>.45\linewidth
      \setlength{\cvpersonRightWidth}{.45\linewidth}%
    \fi

    \begin{tabular}[t]{@{}p{\dimexpr\linewidth-\cvpersonRightWidth\relax}r@{}}%
      % Row 1: Name/Affiliation — Year/Status
      {\raggedright
        #2%
        \IfValueT{#1}{\ \iconlink{\small\faGoogleScholar}{#1}{}}%
      } & #3%
      % Row 2: Only if any of #4–#6 are present
      \IfNoValueTF{#4}{%
        \IfNoValueTF{#5}{%
          \IfNoValueTF{#6}{%
            % none present -> no second row
          }{%
            \\[\tablerowskip]%
            \multicolumn{2}{@{}p{\linewidth}@{}}{#6}%
          }%
        }{%
          \\[\tablerowskip]%
          \multicolumn{2}{@{}p{\linewidth}@{}}{%
            \iconlink{\small\faFileLines}{#5}{}%
            \IfValueT{#6}{\par\addvspace{\tablerowskip}#6}%
          }%
        }%
      }{%
        \\[\tablerowskip]%
        \multicolumn{2}{@{}p{\linewidth}@{}}{%
          #4%
          \IfValueT{#5}{\ \iconlink{\small\faFileLines}{#5}{}}%
          \IfValueT{#6}{\par\addvspace{\tablerowskip}#6}%
        }%
      }%
      \\% final row end
    \end{tabular}%
  \endgroup
}

\NewDocumentCommand{\cvproject}{ o m m o m m m }{%
  % #1 (optional) Project URL (hyperlinks the title)
  % #2 Project title (left)
  % #3 Dates (right)
  % #4 (optional) Agency URL (hyperlinks agency+grant)
  % #5 Agency + grant number (plain if #4 absent)
  % #6 Amount (right, in row 2)
  % #7 Role (left, in row 3)
  \begin{tabularx}{\linewidth}{@{}X r@{}}%
    % Row 1: Title — Dates
    {\raggedright
      \IfNoValueTF{#1}{\textit{#2}}{\href{#1}{\textit{#2}}}%
    } & #3\\[\tablerowskip]
    % Row 2: Agency (+ grant) — Amount
    \IfNoValueTF{#4}{#5}{\href{#4}{#5}} & #6\\[\tablerowskip]
    % Row 3: Role — (empty right cell)
    #7 & \\
  \end{tabularx}%
  \par%
}


%% end of cvstyle.sty