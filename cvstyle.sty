%% cvstyle.sty -- Curriculum Vitae Style Package
%%
%% DESCRIPTION:
%%   Provides a complete styling framework for academic CVs with support
%%   for publications, teaching, service, mentoring, and funded projects.
%%   Includes bibliography integration, custom sectioning, and PDF/A output.
%%
%% PUBLIC API (stable, documented, safe for user CVs):
%%   \cvcontact   - Contact header with name, address, and links
%%   \cvjob       - Position/appointment entry with optional details
%%   \cvperson    - Mentee/collaborator entry with thesis/position info
%%   \cvproject   - Funded project entry with agency, amount, and role
%%   \teachentry  - Teaching course entry with role and offerings
%%
%% SEMI-PUBLIC API (documented but may evolve):
%%   \activityrow - Generic activity listing (title, org, year)
%%   \iconlink    - Hyperlinked icon with text (for contact info)
%%
%% INTERNAL MACROS (prefixed with cv@, no stability guarantees):
%%   \cv@ifnotempty     - Helper for empty string testing (executes code if not empty)
%%   \cv@ifemptyelse - Helper for empty string testing (with both branches)
%%   \cvpersonRightWidth - Length register for \cvperson layout
%%
%% DEPENDENCIES:
%%   Requires biblatex with 'science' style, fontawesome7, pdfx, xparse
%%   Custom datamodel: article-pmcid.dbx
%%   Custom biblatex mods: biblatex_science_mods.sty
%%
%% VERSION HISTORY:
%%   v1.2 (2026-01-28): Comprehensive documentation and best practices update
%%   v1.1 (prior):      Initial structured release
%%
%% CODING CONVENTIONS:
%%   - Use \NewDocumentCommand for commands with optional arguments
%%     or complex patterns (provides better error handling via xparse)
%%   - Use \newcommand for simple commands with only mandatory arguments
%%   - Use \newenvironment for paired begin/end constructs
%%   - Prefix internal-only commands/lengths with \cv@ to avoid conflicts
%%   - Use \providecommand for commands that may be defined elsewhere
%%   - Document all public API commands with structured comment blocks

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cvstyle}[2026/01/28 v1.2 MDL CV style]

% -------------------------
% Version and compatibility information
% -------------------------
% This package requires recent LaTeX distributions (TeX Live 2020 or newer).
% Minimum package versions are specified where breaking changes occurred.

% -------------------------
% Packages (grouped & ordered by dependency)
% -------------------------
% BASIC TEXT & LAYOUT (load first)
% URL typesetting and paragraph spacing control
\RequirePackage{url}
\RequirePackage{parskip}

% GRAPHICS & COLOR (load before packages that use color)
\RequirePackage{graphicx}
\RequirePackage[usenames,dvipsnames]{xcolor}  % Must use xcolor, not color package
% Reduce margins to 10% on all sides for more content space
\RequirePackage[letterpaper,scale=0.9]{geometry}

% PAGE LAYOUT: Headers, footers, and page numbers
\RequirePackage{lastpage}   % For "page X of Y" in footer
\RequirePackage{fancyhdr}   % Custom headers and footers
% \RequirePackage{afterpage}

% -------------------------
% Header/footer behavior
% -------------------------
% Configure section marks to display current section name in footer
% (suppresses automatic uppercasing via \nouppercase in footer below)
% Higher level: Section sets left mark
\renewcommand{\sectionmark}[1]{\markboth{#1}{}}
% Lower level: Subsection sets right mark
\renewcommand{\subsectionmark}[1]{\markright{#1}}

% Set fancy page style as default
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}  % No horizontal rule in header
\fancyhf{}  % Clear all header and footer fields
\fancyfoot[L]{\footnotesize MDL CV -- \nouppercase{\leftmark}}  % Left: "MDL CV -- Section Name"
\fancyfoot[R]{\footnotesize \thepage\ of \pageref{LastPage}}     % Right: "page X of Y"
% Also apply same footer to 'plain' style (used by \maketitle, \chapter, etc.)
\fancypagestyle{plain}{%
  \renewcommand{\headrulewidth}{0pt}%
  \fancyhf{}%
  \fancyfoot[L]{\footnotesize MDL CV -- \nouppercase{\leftmark}}%
  \fancyfoot[R]{\footnotesize \thepage\ of \pageref{LastPage}}%
}
% First page should have no header or footer
\AtBeginDocument{\thispagestyle{empty}}

% -------------------------
% TABLE & COLUMN LAYOUT
% -------------------------
\RequirePackage{array}     % Extended column types for tabular environments
\RequirePackage{ltablex}   % Combines longtable + tabularx for page-breaking tables
\keepXColumns              % Preserve X column proportions when tables break across pages

% Standard vertical spacing between CV entries (3.75pt provides tight but readable spacing)
% Note: This is a public configuration parameter that can be adjusted by users
\newlength{\tablerowskip}
\setlength{\tablerowskip}{3.75pt}

% Suppress extra space before/after longtable environments
\setlength{\LTpre}{0pt}
\setlength{\LTpost}{\tablerowskip}

% LISTS & ENUMERATIONS
\RequirePackage{enumitem}   % Enhanced list formatting; ensures compatibility with etaremune
\RequirePackage{etaremune}  % Reverse-numbered lists (for publications)

% -------------------------
% Internal length registers (prefixed with cv@ for namespace protection)
% -------------------------
% Width holder for right column in \cvperson (calculated dynamically)
% This is used to ensure proper column proportions in the two-column layout
% when the year/status text varies in width.
\newlength{\cvpersonRightWidth}


% -------------------------
% SECTION FORMATTING & LAYOUT
% -------------------------
\RequirePackage{titlesec}   % Custom section/subsection formatting
\RequirePackage{multicol}   % Multi-column layout support
\RequirePackage{needspace}  % Prevent page breaks between heading and following text
\RequirePackage{ragged2e}   % Provides \RaggedRight (better hyphenation than \raggedright)

% Section: Large small-caps with horizontal rule below
\titleformat{\section}{\Large\scshape\raggedright}{}{0em}{}[\titlerule]
\titlespacing{\section}{0pt}{10pt}{10pt}
% Subsection: Bold, no rule
\titleformat{\subsection}{\bfseries\raggedright}{}{0em}{}
\titlespacing{\subsection}{0pt}{10pt}{\tablerowskip}

% -------------------------
% INTERNAL HELPER: Icon + link typesetting
% -------------------------
% \iconlink[<anything>]{<icon>}{<target URL>}{<label>}
%
% Creates a hyperlink with an icon (e.g., FontAwesome) preceding the text.
% If optional argument is present, typesets label with \nolinkurl to allow
% line breaks at appropriate points (useful for email addresses, URLs).
%
% PARAMETERS:
%   [#1] (optional): If present, enables \nolinkurl formatting for #4
%   #2: Icon command (e.g., \small\faGoogleScholar, \faEnvelope)
%   #3: Target URL for hyperlink
%   #4: Visible link text (may be empty for icon-only links)
%
% ROBUSTNESS:
%   - Uses \providecommand to allow other packages to define first if needed
%   - Icon vertical alignment uses \raisebox{-0.05\height} for consistency
%   - Gracefully handles empty labels (icon-only links)
%
% NOTE: This is the canonical definition; biblatex_science_mods.sty uses this command
\providecommand{\iconlink}[4][]{%
  \cv@ifemptyelse{#1}{%
    % Optional flag NOT provided: plain text
    \href{#3}{\raisebox{-0.05\height}{#2}~#4}%
  }{%
    % Optional flag provided: use \nolinkurl for breakable text
    \href{#3}{\raisebox{-0.05\height}{#2}~\nolinkurl{#4}}%
  }%
}
% Keep URL font consistent with surrounding text
\urlstyle{same}

% -------------------------
% BIBLIOGRAPHY CONFIGURATION
% -------------------------
% Use 'science' citation style with custom article-pmcid datamodel
% Configuration: show all authors, article titles, year only, no ISBN/eprint/URL
% Minimum biblatex version 3.16 (2020) recommended for stability
\RequirePackage[style=science, datamodel=article-pmcid, maxnames=99, articletitle=true, date=year, isbn=false, eprint=false, url=false]{biblatex}
% Local modifications to science style (custom .sty file)
\RequirePackage{biblatex_science_mods}

% -------------------------
% ICONS, PDF/A, AND HYPERLINKS
% (Load order critical: fontawesome7 → pdfx → bookmark)
% -------------------------
% WARNING: Package load order matters here!
%   1. fontawesome7 must load before pdfx to ensure proper icon font embedding
%   2. pdfx loads hyperref internally; do not load hyperref explicitly
%   3. bookmark must load after hyperref (which pdfx provides)
\RequirePackage{fontawesome7}    % Icon fonts (must load before pdfx for proper PDF embedding)
\RequirePackage[a-2b]{pdfx}      % PDF/A-2b compliance (loads hyperref internally)
\RequirePackage[open]{bookmark}  % Enhanced PDF bookmarks (requires hyperref, loaded by pdfx)

% Define custom link color and configure hyperref (loaded by pdfx)
% Note: Color names in global namespace; consider using cv@linkcolour for future namespace safety
\definecolor{linkcolour}{rgb}{0,0.2,0.6}  % Dark blue for links
\hypersetup{
  draft=false,    % Enable hyperlinks even in draft mode
  colorlinks,     % Use colored text for links (not boxes)
  breaklinks,     % Allow links to break across lines
  urlcolor=linkcolour,
  linkcolor=linkcolour
}

% Vertical spacing between bibliography entries
\setlength\bibitemsep{\tablerowskip}

% -------------------------
% COMMAND DEFINITION TOOLS
% -------------------------
% xparse provides \NewDocumentCommand for flexible argument handling
% Minimum version: 2018-04-06 (xparse syntax stabilized)
\RequirePackage{xparse}[2018/04/06]

% -------------------------
% INTERNAL UTILITY MACROS
% (Not part of public API; prefixed with cv@ to prevent namespace conflicts)
% -------------------------

% \cv@ifnotempty{<text>}{<not empty code>}
%
% Helper macro to test if argument is empty and execute code if not empty.
% Uses robust \if\relax\detokenize pattern for proper empty testing.
%
% PARAMETERS:
%   #1: Text to test for emptiness
%   #2: Code to execute if #1 is not empty
%
% INTERNAL USE ONLY - reduces code duplication in public commands
\newcommand{\cv@ifnotempty}[2]{%
  \if\relax\detokenize{#1}\relax
    % empty - do nothing
  \else
    #2%
  \fi
}

% \cv@ifemptyelse{<text>}{<empty code>}{<not empty code>}
%
% Helper macro to test if argument is empty and execute appropriate code branch.
% Uses robust \if\relax\detokenize pattern for proper empty testing.
%
% PARAMETERS:
%   #1: Text to test for emptiness
%   #2: Code to execute if #1 is empty
%   #3: Code to execute if #1 is not empty
%
% INTERNAL USE ONLY - reduces code duplication in public commands
\newcommand{\cv@ifemptyelse}[3]{%
  \if\relax\detokenize{#1}\relax
    #2% empty branch
  \else
    #3% not empty branch
  \fi
}

% -------------------------
% PUBLIC API: Activity listing commands
% -------------------------

% \begin{activityshort}{<activity>}{<year>} ... \end{activityshort}
%
% Simple environment for short activity descriptions.
% Creates a three-column row: activity (italic) — (space) — year
%
% PARAMETERS:
%   #1: Activity name (typeset in italics)
%   #2: Year or date range
%
% NOTE: Environment body is currently empty; content goes in parameters
\newenvironment{activityshort}[2]
{
    \begin{tabularx}{\linewidth}{@{}l X r@{}}
    \textit{#1} & \hfill & #2
    \end{tabularx} \par%
}
{
}

% \activityrow[<url>]{<title>}{<organization>}{<year>}
%
% Generic activity listing as table row (for use within tabularx environment).
% Title is hyperlinked if URL provided; organization shown in italics with comma.
%
% PARAMETERS:
%   [#1] (optional): URL to hyperlink the title
%   #2: Activity title
%   #3: Organization name (may be empty; omits comma if empty)
%   #4: Year or date range
%
% USAGE:
%   \begin{tabularx}{\linewidth}{X r}
%   \activityrow[https://...]{Conference Talk}{Org Name}{2025}
%   \activityrow{Other Activity}{}{2024}  % No org, no URL
%   \end{tabularx}
\newcommand{\activityrow}[4][]{%
  % Title with optional hyperlink using helper macro
  \cv@ifemptyelse{#1}{%
    #2%
  }{%
    \href{#1}{#2}%
  }%
  % Organization (adds comma only if non-empty) using helper macro
  \cv@ifnotempty{#3}{, \textit{#3}}%
  \space & #4 \\[\tablerowskip]%
}

% -------------------------
% LIST FORMATTING DEFAULTS
% -------------------------
% Remove default spacing above lists; use consistent \tablerowskip between items
\setlist{itemsep=\tablerowskip, topsep=0pt, parsep=0pt}
% Remove bullets from first-level itemize (for CV entries that appear as lists)
\renewcommand{\labelitemi}{}
\setlist[itemize,1]{leftmargin=0pt}

% -------------------------
% PUBLIC API: Teaching entry command
% -------------------------

% \teachentry{<course>}{<role>}{<offerings1>}{<offerings2>}
%
% Typesets a teaching entry in two columns within a tabularx environment.
% Left column shows course name (italic) and role; right column shows
% offering details (up to two lines, right-aligned).
%
% PARAMETERS:
%   #1: Course name (typeset in italics)
%   #2: Role (e.g., "Instructor", "Teaching Assistant")
%   #3: First line of offerings (e.g., "Fall 2024, Spring 2025")
%   #4: Second line of offerings (optional; omit or leave empty for single line)
%
% USAGE:
%   \begin{tabularx}{\linewidth}{X Z}
%   \teachentry{Advanced Algorithms}{Instructor}{Fall 2024}{Spring 2025}
%   \teachentry{Data Structures}{TA}{Spring 2024}{}
%   \end{tabularx}
%
% NOTE: Uses 4× \tablerowskip vertical spacing after entry for visual separation
\newcommand{\teachentry}[4]{%
  % Left cell (course + role). Use \hsize for width in X columns.
  \parbox[t]{\hsize}{%
    \raggedright
    \emph{#1}\par
    #2%
  }%
  &%
  % Right cell (offerings, possibly two lines)
  \parbox[t]{\hsize}{%
    \raggedleft
    #3\par
    \cv@ifnotempty{#4}{#4}%
  }%
  \\[\dimexpr4.5\tablerowskip\relax]%
}

% ========================================================================
% PUBLIC API: Main CV Entry Commands
% ========================================================================
% The following commands form the primary interface for creating CV content.
% All are designed for consistent spacing (\tablerowskip) and support
% optional hyperlinks where appropriate.

% -------------------------
% \cvcontact{<Name>}{<address/contact line>}{<links line>}
% -------------------------
% Creates the contact header at the top of the CV with name, address, and links.
%
% PARAMETERS:
%   #1: Full name (typeset in \Huge size)
%   #2: Address and contact info (single line, e.g., email, phone)
%   #3: Professional links (ORCID, website, Google Scholar, etc.)
%       Use \iconlink for each link with appropriate FontAwesome icons
%
% USAGE:
%   \cvcontact{Jane Q. Researcher}{
%     Department of Science, University Name \textbar\ 
%     \iconlink[*]{\faEnvelope}{mailto:jane@uni.edu}{jane@uni.edu} \textbar\ 
%     \iconlink{\faPhone}{tel:+15551234567}{+1 (555) 123-4567}
%   }{
%     \iconlink{\faOrcid}{https://orcid.org/0000-0001-2345-6789}{0000-0001-2345-6789} \textbar\ 
%     \iconlink{\faGlobe}{https://janedoe.com}{janedoe.com}
%   }
\newcommand{\cvcontact}[3]{%
  \noindent
  \begin{minipage}{\linewidth}
    {\Huge #1\par\vspace{\tablerowskip}}%
    \RaggedRight #2\par
    \RaggedRight #3\par
  \end{minipage}%
}

% -------------------------
% \cvjob{<title>}{<dates>}[<optional content>]
% -------------------------
% Typesets a job or appointment entry with title and dates on first line,
% followed by optional detailed content (responsibilities, achievements, etc.).
%
% PARAMETERS:
%   #1 (required): Job title or appointment text (typeset in bold)
%   #2 (required): Date range string (e.g., "2020--Present", "Jan 2018--Dec 2020")
%   [#3] (optional): Additional content block (itemize, description, paragraph, etc.)
%
% USAGE:
%   \cvjob{Assistant Professor}{2020--Present}[
%     \begin{itemize}
%       \item Research in computational biology and machine learning
%       \item Teaching undergraduate and graduate courses
%       \item Supervising 3 PhD students and 2 postdocs
%     \end{itemize}
%   ]
%
%   \cvjob{Postdoctoral Researcher}{2017--2020}  % No optional content
%
% NOTES:
%   - Uses tabularx for title/date alignment
%   - Optional content appears in full-width minipage
%   - Negative \vspace compensates for \parskip to avoid extra blank line
\NewDocumentCommand{\cvjob}{ m m o }{%
  \begin{tabularx}{\linewidth}{@{}l X r@{}}%
    \textbf{#1} & \hfill & #2%
  \end{tabularx}%
  % Add optional content block if provided
  \IfValueT{#3}{%
    \vspace{-\parskip}%  % Remove extra blank line between title row and content
    \noindent\begin{minipage}[t]{\linewidth}%
      #3%
    \end{minipage}%
  }%
  \par\vspace{\dimexpr1.5\tablerowskip\relax}%
}

% -------------------------
% \cvperson[<scholar URL>]{<name+affil>}{<year>}[<thesis>][<thesis URL>][<text next to thesis icon>][<position>]
% -------------------------
\NewDocumentCommand{\cvperson}{ o m m o o o o }{%
  \begingroup
    \setlength{\tabcolsep}{0.5em}%
    \renewcommand{\arraystretch}{1}%

    % Measure natural width of right cell (#3 = year/status)
    \settowidth{\cvpersonRightWidth}{\strut #3}%
    % Clamp to max 45% of line width to prevent negative left column width
    \ifdim\cvpersonRightWidth>.45\linewidth
      \setlength{\cvpersonRightWidth}{.45\linewidth}%
    \fi

    \begin{tabular}[t]{@{}p{\dimexpr\linewidth-\cvpersonRightWidth-1em\relax}r@{}}%
      % Row 1: Name/Affiliation — Year/Status
      {\raggedright
        #2%
        \IfValueT{#1}{\ \iconlink{\small\faGoogleScholar}{#1}{}}%
      } & #3\\
      % Row 2: Thesis (if any) — confined to left cell; right cell intentionally blank
      \IfNoValueTF{#4}{%
        % no thesis text provided
        \IfNoValueTF{#5}{%
          % no thesis URL either -> nothing on row 2
        }{%
          % URL provided without thesis text: show just the icon link on its own line
          \iconlink{\small\faFileLines}{#5}{} & \\%
        }%
      }{%
        % thesis text provided
        \begingroup
          \raggedright
          #4%
          \IfValueT{#5}{%
            \IfNoValueTF{#6}{%
              \ \iconlink{\small\faFileLines}{#5}{}%
            }{%
              \ \iconlink{\small\faFileLines}{#5}{#6}%
            }%
          }%
        \endgroup
        & \\%
      }%
      % Row 3: Position (if any) — confined to left cell; right cell intentionally blank
      \IfValueT{#7}{%
        #7 & \\%
      }%
    \end{tabular}%
  \endgroup
}

% -------------------------
% \cvproject[<proj URL>]{<title>}{<dates>}[<agency URL>]{<agency+grant>}{<amount>}{<role>}
% -------------------------
% Typesets a funded research project entry with title, dates, funding agency,
% grant number, award amount, and investigator role.
%
% PARAMETERS:
%   [#1] (optional): Project website URL (hyperlinks the title)
%   #2 (required): Project title (typeset in italics)
%   #3 (required): Date range (e.g., "2022--2025")
%   [#4] (optional): Agency website URL (hyperlinks agency+grant)
%   #5 (required): Funding agency and grant number
%   #6 (required): Award amount (e.g., "$500,000")
%   #7 (required): Role (e.g., "Principal Investigator", "Co-PI")
%
% USAGE:
%   \cvproject[https://project-site.org]{%
%     Computational Approaches to Genome Assembly
%   }{2022--2025}[https://nsf.gov/awardsearch/showAward?AWD_ID=1234567]{%
%     National Science Foundation, Award \#1234567
%   }{\$500,000}{%
%     Principal Investigator
%   }
%
%   % Without optional URLs
%   \cvproject{%
%     Novel Methods for Data Analysis
%   }{2023--2024}{%
%     Internal University Grant
%   }{\$25,000}{%
%     Co-Investigator
%   }
%
% NOTES:
%   - Three-row tabularx layout: Title—Dates / Agency—Amount / Role—(empty)
%   - Title and agency/grant are hyperlinked if corresponding URLs provided
\NewDocumentCommand{\cvproject}{ o m m o m m m }{%
  \begin{tabularx}{\linewidth}{@{}X r@{}}%
    % Row 1: Title — Dates
    {\raggedright
      \IfNoValueTF{#1}{\textit{#2}}{\href{#1}{\textit{#2}}}%
    } & #3\\
    % Row 2: Agency (+ grant) — Amount
    \IfNoValueTF{#4}{#5}{\href{#4}{#5}} & #6\\
    % Row 3: Role — (empty right cell)
    #7 & \\[\tablerowskip]
  \end{tabularx}%
  \par%
}


%% ========================================================================
%% TROUBLESHOOTING & KNOWN ISSUES
%% ========================================================================
%%
%% FONTAWESOME ICONS NOT DISPLAYING:
%%   • Ensure fontawesome7 is installed in your TeX distribution
%%   • Run: tlmgr install fontawesome7 (TeX Live) or use MiKTeX Package Manager
%%   • If icons still don't appear, check console output for font loading errors
%%
%% PACKAGE LOAD ORDER CONFLICTS:
%%   • pdfx loads hyperref internally; do not \RequirePackage{hyperref} explicitly
%%   • fontawesome7 must load before pdfx for proper font embedding in PDF/A
%%   • If using other packages that modify hyperref, load them after cvstyle
%%
%% BIBLIOGRAPHY ISSUES:
%%   • biblatex_science_mods.sty must load after biblatex but before document
%%   • Ensure article-pmcid.dbx is in the same directory as cv.tex
%%   • Run biber (not bibtex) for bibliography processing: biber cv
%%
%% COLUMN WIDTH ISSUES IN \cvperson:
%%   • If year/status text exceeds 45% of line width, it will be clamped
%%   • This prevents negative width in the left column (name/affiliation)
%%   • Consider abbreviating very long status strings (e.g., "In Progress" → "2024–")
%%
%% VERSION COMPATIBILITY:
%%   • Requires TeX Live 2020 or newer for stable xparse/biblatex versions
%%   • If using older TeX distributions, some features may not work correctly
%%   • Update your TeX distribution if encountering unexplained errors
%%
%% HYPERREF CONFIGURATION:
%%   • Link colors defined globally as 'linkcolour' (may conflict with other packages)
%%   • To change link colors, redefine after loading cvstyle:
%%     \definecolor{linkcolour}{rgb}{r,g,b}
%%     \hypersetup{urlcolor=linkcolour, linkcolor=linkcolour}

%% end of cvstyle.sty