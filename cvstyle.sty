%% cvstyle.sty -- shared preamble, macros, and layout for cv.tex
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cvstyle}[2025/11/04 v1.1 MDL CV style]

% -------------------------
% Packages (grouped & ordered)
% -------------------------
% Basic helpers: URL handling, paragraph spacing
\RequirePackage{url}
\RequirePackage{parskip}

% Graphics & color (use xcolor; do not load `color` separately)
\RequirePackage{graphicx}
\RequirePackage[usenames,dvipsnames]{xcolor}
\RequirePackage[letterpaper,scale=0.9]{geometry}

% Page numbering / header & footer
\RequirePackage{lastpage}
\RequirePackage{fancyhdr}

% -------------------------
% Header/footer behavior
% -------------------------
% Mark section titles for footer
\makeatletter
\renewcommand{\sectionmark}[1]{\markright{#1}}
\renewcommand{\subsectionmark}[1]{\markright{#1}}
\makeatother

\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\fancyhf{}
\fancyfoot[L]{\footnotesize MDL CV -- \nouppercase{\rightmark}}
\fancyfoot[R]{\footnotesize \thepage\ of \pageref{LastPage}}
\fancypagestyle{plain}{%
  \renewcommand{\headrulewidth}{0pt}%
  \fancyhf{}%
  \fancyfoot[L]{\footnotesize MDL CV -- \nouppercase{\rightmark}}%
  \fancyfoot[R]{\footnotesize \thepage\ of \pageref{LastPage}}%
}
\AtBeginDocument{\thispagestyle{empty}}

% -------------------------
% Layout helpers
% -------------------------
\RequirePackage{tabularx}
\newcommand{\tablerowskip}{3.75pt}

% Lists, enumerations, and reverse enumerations
\RequirePackage{etaremune}
\RequirePackage{enumitem} % make sure enumitem understands etaremune lists

% Small length used in a few places
\newlength{\fullcollw}
\setlength{\fullcollw}{0.47\textwidth}

% Section formatting and multi-column layout
\RequirePackage{titlesec}
\RequirePackage{multicol}

\titleformat{\section}{\Large\scshape\raggedright}{}{0em}{}[\titlerule]
\titlespacing{\section}{0pt}{10pt}{10pt}
\titleformat{\subsection}{\bfseries\raggedright}{}{0em}{}
\titlespacing{\subsection}{0pt}{10pt}{\tablerowskip}

% Icon + link helper
% \iconlink[<anything>]{<icon>}{<target URL>}{<label>}
% If [] is present, label is typeset with \nolinkurl; else plain.
% \nolinkurl allows hyperref to break visible text like a url
\newcommand{\iconlink}[4][]{%
  % #1 = optional flag (when present, #4 is typeset with \nolinkurl)
  % #2 = icon or small graphic (e.g., \small\faGoogleScholar)
  % #3 = URL
  % #4 = visible text (may be empty)
  \if\relax\detokenize{#1}\relax
    % Optional flag NOT provided
    \href{#3}{\raisebox{-0.05\height}{#2}~#4}%
  \else
    % Optional flag provided
    \href{#3}{\raisebox{-0.05\height}{#2}~\nolinkurl{#4}}%
  \fi
}
% Optional to keep the font consistent:
\urlstyle{same}

% -------------------------
% Bibliography
% -------------------------
% Keep the 'science' style and local modifications package
\RequirePackage[style=science, datamodel=article-pmcid, maxnames=99, articletitle=true, date=year, isbn=false, eprint=false, url=false]{biblatex}
\RequirePackage{biblatex_science_mods}

% -------------------------
% Icons, PDF/A and hyperlinks
% -------------------------
\RequirePackage{fontawesome7}
\RequirePackage[a-2b]{pdfx}  % loads hyperref
\RequirePackage[open]{bookmark}
\definecolor{linkcolour}{rgb}{0,0.2,0.6}
\hypersetup{
  draft=false,
  colorlinks,
  breaklinks,
  urlcolor=linkcolour,
  linkcolor=linkcolour
}

\setlength\bibitemsep{\tablerowskip}

% -------------------------
% Small utility macros
% -------------------------

% for custom macros
\RequirePackage{xparse}

% If-non-empty helper specifically for optional URL arguments
\newcommand{\IfNonEmptyURL}[2]{%
  \if\relax\detokenize{#1}\relax
  \else
    #2%
  \fi
}

% activity listing environment
\newenvironment{activityshort}[2]
{
    \begin{tabularx}{\linewidth}{@{}l X r@{}}
    \textit{#1} & \hfill & #2
    \end{tabularx} \par%
}
{
}

\newcommand{\activitynone}[2][]{%
    \begin{tabularx}{\linewidth}{@{}l X r@{}}
    \textit{#1} & \hfill & #2
    \end{tabularx} \par%
}

% list activity as row in table instead
\newcommand{\activityrow}[4][]{%
  % #1 = optional URL (may be empty)
  % #2 = title
  % #3 = organization (may be empty)
  % #4 = year(s)
  % Title with optional link:
  \if\relax\detokenize{#1}\relax
    % No URL provided
    #2%
  \else
    % URL provided
    \href{#1}{#2}%
  \fi
  % Optional org (adds comma only if non-empty):
  \if\relax\detokenize{#3}\relax
    % Org empty: print nothing
  \else
    , \textit{#3}%
  \fi
  \space & #4 \\[\tablerowskip]%
}

% set spacing for all lists
\setlist{itemsep=\tablerowskip, topsep=0pt, parsep=0pt}
% typography tweaks for itemize
\renewcommand{\labelitemi}{}
\setlist[itemize,1]{leftmargin=0pt}

% teaching, service column types
\newcolumntype{Y}{>{\raggedright\arraybackslash}p{0.53\textwidth}}
\newcolumntype{Z}{>{\raggedleft\arraybackslash}X}

\newcommand{\teachinstitution}[1]{%
  \multicolumn{2}{l}{\textbf{#1}}\\[\tablerowskip]%
}

\newcommand{\teachentry}[4]{%
  \emph{#1} & #3 \\%
  #2 &%
  \if\relax\detokenize{#4}\relax\else#4\fi%
  \\[\tablerowskip]%
}

% -------------------------
% New, compact macros (public API)
% -------------------------

% \cvcontact{<Name>}{<address/contact line>}{<links line>}
%   #1: full name (printed large)
%   #2: address/contact (single line)
%   #3: extra links (ORCID, website, scholar, etc.)
\newcommand{\cvcontact}[3]{%
  \begin{tabularx}{\linewidth}{@{} l @{}}
    \Huge{#1} \\[7.5pt]
    #2 \\
    #3 \\
  \end{tabularx}%
}

% \cvjob{<title>}{<dates>}[<optional content>]
%   #1: job title / appointment text
%   #2: dates (string)
%   [#3]: optional content token (often an itemize or description block)
\NewDocumentCommand{\cvjob}{ m m o }{%
  \begin{tabularx}{\linewidth}{@{}l X r@{}}
    \textbf{#1} & \hfill & #2
  \end{tabularx}\par%
  \IfValueT{#3}{\begin{minipage}[t]{\linewidth}#3\end{minipage}}%
}

% Arguments:
% #1 (optional): Google Scholar URL
% #2 (required): Name and field
% #3 (required): Year
% #4 (optional): Thesis title
% #5 (optional): Thesis/DOI URL
% #6 (optional): Current position
\NewDocumentCommand{\cvperson}{ o m m o o o }{%
  \begin{tabularx}{\linewidth}{@{}l X r@{}}
    % Left cell: stacked content
    \raggedright #2%
    \IfValueT{#1}{\ \iconlink{\small\faGoogleScholar}{#1}{}}
    & \hfill &
    % Right cell: year (top-aligned, dynamic width)
    #3
  \end{tabularx}
  \IfValueT{#4}{\\[\tablerowskip]\begin{minipage}[t]{\linewidth}
    #4%
    \IfValueT{#5}{\ \iconlink{\small\faFileLines}{#5}{}}
    \IfValueT{#6}{\\[\tablerowskip] #6}
  \end{minipage}}{\par}
}

\NewDocumentCommand{\cvproject}{ o m m o m m m }{%
  % #1 (optional) = Project URL (hyperlinks the title)
  % #2 = Project title (left)
  % #3 = Dates (right)
  % #4 (optional) = Agency URL (hyperlinks agency+grant)
  % #5 = Agency + grant number (plain text if #4 not given)
  % #6 = Amount of award (right column in the agency row)
  % #7 = Role (left column in the role row)
  \begin{tabularx}{\linewidth}{@{}l X r@{}}%
    % Row 1: Title (hyperlinked if #1) + Dates
    \parbox[t]{0.76\linewidth}{\raggedright
      \IfNoValueTF{#1}{\textit{#2}}{\href{#1}{\textit{#2}}}%
    } & \hfill & #3 
  \end{tabularx} \\[\tablerowskip]%
  % Row 2: Agency (+ grant), optionally hyperlinked, and amount on the right
  \IfNoValueTF{#4}{#5}{\href{#4}{#5}} \hfill #6 \\[\tablerowskip]%
  % Row 3: Role (left)
  #7 %
}


%% end of cvstyle.sty